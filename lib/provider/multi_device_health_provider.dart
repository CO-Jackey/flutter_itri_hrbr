import 'package:flutter_itri_hrbr/model/health_data.dart';
import 'package:flutter_blue_plus/flutter_blue_plus.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_riverpod/legacy.dart';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ¯ æ ¸å¿ƒ Providerï¼šæ¯å€‹è£ç½®ç¨ç«‹çš„ Family Provider
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// å¤šè£ç½®å¥åº·è³‡æ–™ Providerï¼ˆFamily æ¨¡å¼ï¼‰
/// 
/// ğŸ“‹ ä½¿ç”¨æ–¹å¼ï¼š
/// - è®€å–ï¼š`ref.watch(multiDeviceHealthProvider(deviceId))`
/// - æ›´æ–°ï¼š`ref.read(multiDeviceHealthProvider(deviceId).notifier).update(data)`
/// - æ¸…ç†ï¼š`ref.invalidate(multiDeviceHealthProvider(deviceId))`
final multiDeviceHealthProvider = StateNotifierProvider.family<
    MultiDeviceHealthNotifier,
    HealthData,
    DeviceIdentifier  // â† Family åƒæ•¸ï¼šè£ç½® ID
>((ref, deviceId) => MultiDeviceHealthNotifier(deviceId));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ­ æ‰¹æ¬¡æ“ä½œç®¡ç†å™¨ï¼ˆé›†ä¸­ç®¡ç†å¤šè£ç½®æ›´æ–°ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// æ‰¹æ¬¡å¥åº·è³‡æ–™æ›´æ–°ç®¡ç†å™¨
/// 
/// ğŸ“‹ åŠŸèƒ½ï¼š
/// - `batchUpdate()`ï¼šæ‰¹æ¬¡æ›´æ–°å¤šå€‹è£ç½®
/// - `removeDevice()`ï¼šç§»é™¤å–®ä¸€è£ç½®è³‡æ–™
/// - `clearAll()`ï¼šæ¸…ç©ºæ‰€æœ‰è£ç½®è³‡æ–™
final batchHealthUpdaterProvider = Provider((ref) => BatchHealthUpdater(ref));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“¦ è¼”åŠ©å·¥å…·ï¼šé è¨­ç©ºè³‡æ–™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// å»ºç«‹ä¸€å€‹ã€Œå…¨ 0 / ç©ºã€çš„é è¨­ HealthData
HealthData _zeroHealthData() => HealthData(
  hr: 0,
  br: 0,
  gyroX: 0,
  gyroY: 0,
  gyroZ: 0,
  temp: 0.0,
  hum: 0.0,
  spO2: 0,
  step: 0,
  power: 0,
  time: 0,
  hrFiltered: const [],
  brFiltered: const [],
  isWearing: false,
  rawData: const [],
  type: 0,
  fftOut: const [],
  petPose: 0,
  splitRawData: const [],
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ§  å–®ä¸€è£ç½®çš„å¥åº·è³‡æ–™ç®¡ç†å™¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// å–®ä¸€è£ç½®çš„å¥åº·è³‡æ–™ç‹€æ…‹ç®¡ç†
/// 
/// ğŸ“‹ æä¾›æ–¹æ³•ï¼š
/// - `update()`ï¼šå®Œæ•´æ›´æ–°
/// - `patch()`ï¼šéƒ¨åˆ†æ›´æ–°
/// - `reset()`ï¼šé‡ç½®ç‚ºç©ºè³‡æ–™
class MultiDeviceHealthNotifier extends StateNotifier<HealthData> {
  final DeviceIdentifier deviceId;

  /// å»ºæ§‹å­ï¼šåˆå§‹åŒ–ç‚ºç©ºè³‡æ–™
  MultiDeviceHealthNotifier(this.deviceId) : super(_zeroHealthData());

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âœ… å®Œæ•´æ›´æ–°ï¼šæ›¿æ›æ•´å€‹ HealthData
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// å®Œæ•´æ›´æ–°å¥åº·è³‡æ–™
  /// 
  /// ä½¿ç”¨æ™‚æ©Ÿï¼šå¾è—ç‰™æ¥æ”¶åˆ°å®Œæ•´çš„æ–°è³‡æ–™
  void update(HealthData newData) {
    state = newData;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ”§ éƒ¨åˆ†æ›´æ–°ï¼šåªæ›´æ–°æŒ‡å®šæ¬„ä½
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// éƒ¨åˆ†æ›´æ–°å¥åº·è³‡æ–™ï¼ˆpatchï¼‰
  /// 
  /// ä½¿ç”¨æ™‚æ©Ÿï¼šåªéœ€æ›´æ–°ç‰¹å®šæ¬„ä½æ™‚
  /// 
  /// ç¯„ä¾‹ï¼š
  /// ```dart
  /// notifier.patch(hr: 75, temp: 36.5);
  /// ```
  void patch({
    int? hr,
    int? br,
    int? gyroX,
    int? gyroY,
    int? gyroZ,
    double? temp,
    double? hum,
    int? spO2,
    int? step,
    int? power,
    int? time,
    List<double>? hrFiltered,
    List<double>? brFiltered,
    bool? isWearing,
    List<int>? rawData,
    int? type,
    List<double>? fftOut,
    int? petPose,
    List<int>? splitRawData,
  }) {
    state = state.copyWith(
      hr: hr ?? state.hr,
      br: br ?? state.br,
      gyroX: gyroX ?? state.gyroX,
      gyroY: gyroY ?? state.gyroY,
      gyroZ: gyroZ ?? state.gyroZ,
      temp: temp ?? state.temp,
      hum: hum ?? state.hum,
      spO2: spO2 ?? state.spO2,
      step: step ?? state.step,
      power: power ?? state.power,
      time: time ?? state.time,
      hrFiltered: hrFiltered ?? state.hrFiltered,
      brFiltered: brFiltered ?? state.brFiltered,
      isWearing: isWearing ?? state.isWearing,
      rawData: rawData ?? state.rawData,
      type: type ?? state.type,
      fftOut: fftOut ?? state.fftOut,
      petPose: petPose ?? state.petPose,
      splitRawData: splitRawData ?? state.splitRawData,
    );
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ—‘ï¸ é‡ç½®è³‡æ–™
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// é‡ç½®ç‚ºåˆå§‹ç©ºè³‡æ–™
  /// 
  /// ä½¿ç”¨æ™‚æ©Ÿï¼šè£ç½®æ–·ç·šå¾Œæ¸…ç©ºè³‡æ–™
  void reset() {
    state = _zeroHealthData();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›ï¸ æ‰¹æ¬¡æ“ä½œç®¡ç†å™¨å¯¦ä½œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/// æ‰¹æ¬¡å¥åº·è³‡æ–™æ›´æ–°ç®¡ç†å™¨
/// 
/// ğŸ“‹ è·è²¬ï¼š
/// - æä¾›æ‰¹æ¬¡æ“ä½œçš„çµ±ä¸€ä»‹é¢
/// - é¿å…åœ¨ Service å±¤ç›´æ¥æ“ä½œ provider
class BatchHealthUpdater {
  final Ref _ref;

  BatchHealthUpdater(this._ref);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ“¤ æ‰¹æ¬¡æ›´æ–°å¤šå€‹è£ç½®
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// æ‰¹æ¬¡æ›´æ–°å¤šå€‹è£ç½®çš„å¥åº·è³‡æ–™
  /// 
  /// ğŸ“‹ ä½¿ç”¨æ™‚æ©Ÿï¼š
  /// - Service ç´¯ç©å¤šå€‹è£ç½®çš„è³‡æ–™å¾Œçµ±ä¸€é€å‡º
  /// - æ¸›å°‘ UI rebuild æ¬¡æ•¸
  /// 
  /// ç¯„ä¾‹ï¼š
  /// ```dart
  /// final updates = {
  ///   deviceId1: healthData1,
  ///   deviceId2: healthData2,
  /// };
  /// batchUpdater.batchUpdate(updates);
  /// ```
  void batchUpdate(Map<DeviceIdentifier, HealthData> updates) {
    for (final entry in updates.entries) {
      _ref
          .read(multiDeviceHealthProvider(entry.key).notifier)
          .update(entry.value);
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ—‘ï¸ ç§»é™¤å–®ä¸€è£ç½®
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// ç§»é™¤å–®ä¸€è£ç½®çš„å¥åº·è³‡æ–™
  /// 
  /// ğŸ“‹ ä½¿ç”¨æ™‚æ©Ÿï¼š
  /// - è£ç½®æ–·ç·šæ™‚æ¸…ç†è³‡æ–™
  /// 
  /// ğŸ”§ å¯¦ä½œæ–¹å¼ï¼š
  /// 1. å…ˆé‡ç½®ç‚ºç©ºè³‡æ–™ï¼ˆå¯é¸ï¼‰
  /// 2. å®Œå…¨ invalidate è©² providerï¼ˆé‡‹æ”¾è¨˜æ†¶é«”ï¼‰
  void removeDevice(DeviceIdentifier id) {
    // æ­¥é©Ÿ 1ï¼šé‡ç½®è³‡æ–™ï¼ˆå¯é¸ï¼Œè¦–éœ€æ±‚æ±ºå®šæ˜¯å¦ä¿ç•™ï¼‰
    // _ref.read(multiDeviceHealthProvider(id).notifier).reset();

    // æ­¥é©Ÿ 2ï¼šå®Œå…¨ç§»é™¤è©² family instanceï¼ˆé‡‹æ”¾è¨˜æ†¶é«”ï¼‰
    _ref.invalidate(multiDeviceHealthProvider(id));
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è£ç½®
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// æ¸…ç©ºæ‰€æœ‰è£ç½®çš„å¥åº·è³‡æ–™
  /// 
  /// ğŸ“‹ ä½¿ç”¨æ™‚æ©Ÿï¼š
  /// - æ‰¹æ¬¡æ–·ç·šæ™‚ä¸€æ¬¡æ€§æ¸…ç†æ‰€æœ‰è£ç½®
  /// - App é‡ç½®æ™‚æ¸…ç©ºæ‰€æœ‰è³‡æ–™
  /// 
  /// âš ï¸ æ³¨æ„ï¼š
  /// - éœ€è¦å‚³å…¥æ‰€æœ‰è£ç½® ID åˆ—è¡¨
  /// - æœƒ invalidate æ‰€æœ‰ family instance
  void clearAll(List<DeviceIdentifier> deviceIds) {
    for (final id in deviceIds) {
      _ref.invalidate(multiDeviceHealthProvider(id));
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ğŸ” è¼”åŠ©æ–¹æ³•ï¼šæª¢æŸ¥è£ç½®æ˜¯å¦æœ‰è³‡æ–™ï¼ˆå¯é¸ï¼‰
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  
  /// æª¢æŸ¥è£ç½®æ˜¯å¦æœ‰éç©ºè³‡æ–™
  /// 
  /// ğŸ“‹ åˆ¤æ–·é‚è¼¯ï¼š
  /// - å¿ƒç‡ > 0 æˆ–é«”æº« > 0 è¦–ç‚ºæœ‰æ•ˆè³‡æ–™
  bool hasValidData(DeviceIdentifier id) {
    try {
      final data = _ref.read(multiDeviceHealthProvider(id));
      return data.hr > 0 || data.temp > 0;
    } catch (e) {
      // Provider ä¸å­˜åœ¨
      return false;
    }
  }

  /// å–å¾—æ‰€æœ‰æœ‰è³‡æ–™çš„è£ç½® IDï¼ˆå¯é¸ï¼‰
  /// 
  /// âš ï¸ é™åˆ¶ï¼š
  /// - Family provider ç„¡æ³•ç›´æ¥åˆ—èˆ‰æ‰€æœ‰ instance
  /// - å¿…é ˆç”±å¤–éƒ¨å‚³å…¥ deviceIds åˆ—è¡¨
  List<DeviceIdentifier> getActiveDevices(List<DeviceIdentifier> allDeviceIds) {
    return allDeviceIds.where((id) => hasValidData(id)).toList();
  }
}
